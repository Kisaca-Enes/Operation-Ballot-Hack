import time
import difflib

EXPECTED_TERMS = [
    "from pwn import *",
    "context.binary",
    "ELF",
    "ROP",
    "puts",
    "GOT",
    "leak",
    "libc",
    "system",
    "/bin/sh",
    "ljust",
    "ROP chain",
    "libc_base",
    "call",
    "symbols['main']",
    "interactive"
]

# Basit bir Kaspersky shellcode "database" Ã¶rneÄŸi (gerÃ§ek senaryoda daha kapsamlÄ± olur)
KNOWN_SHELLCODES = [
    b"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80",  # execve /bin/sh
    b"\x90\x90\x90\x90",  # basit NOP sled Ã¶rneÄŸi
]

# ASLR/AV bypass iÃ§in aranan kelimeler
BYPASS_TERMS = [
    "xor",
    "add rsp",
    "ret2libc",
    "jmp rsp",
    "mprotect",
    "virtualalloc",
    "shellcode polymorphic",
    "obfuscate",
    "encode",
    "decrypt",
]

def check_similarity(code_bytes, known_shellcode):
    seq = difflib.SequenceMatcher(None, code_bytes, known_shellcode)
    return seq.ratio()  # 0-1 arasÄ± benzerlik oranÄ±

def exploit_degerlendir(code):
    score = 0
    code_lower = code.lower()
    for term in EXPECTED_TERMS:
        if term.lower() in code_lower:
            score += 1

    percent = int((score / len(EXPECTED_TERMS)) * 100)
    return percent

def check_kaspersky_bypass(code):
    code_bytes = code.encode(errors='ignore')
    for shellcode in KNOWN_SHELLCODES:
        similarity = check_similarity(code_bytes, shellcode)
        if similarity > 0.4:
            return False, similarity
    return True, 0

def check_aslr_bypass(code):
    code_lower = code.lower()
    for term in BYPASS_TERMS:
        if term in code_lower:
            return True
    return False

def main():
    print("=== KGB Exploit Test Terminali ===")
    print("AÅŸaÄŸÄ±ya Unicode tabanlÄ± exploitinizi yazÄ±n.")
    print("YazmayÄ± bitirmek iÃ§in boÅŸ bir satÄ±r girin.\n")

    lines = []
    while True:
        line = input("> ")
        if line.strip() == "":
            break
        lines.append(line)

    user_code = "\n".join(lines)
    print("\nExploit deÄŸerlendirmesi yapÄ±lÄ±yor...")
    time.sleep(1)

    percent = exploit_degerlendir(user_code)
    kaspersky_ok, similarity = check_kaspersky_bypass(user_code)
    aslr_ok = check_aslr_bypass(user_code)

    print(f"\nExploit Benzerlik OranÄ±: %{percent}")

    if not kaspersky_ok:
        print(f"âš ï¸ UyarÄ±: Exploitiniz Kaspersky'nin bilinen shellcode Ã¶rneklerine benzerlik gÃ¶steriyor (Benzerlik: %{similarity*100:.1f}).")
        print("Shellcode'u polymorphic, encode veya obfuscate ederek deÄŸiÅŸtirmeniz gerekiyor!")

    if not aslr_ok:
        print("âš ï¸ UyarÄ±: ASLR veya AV bypass teknikleri tespit edilmedi.")
        print("LÃ¼tfen XOR, mprotect, ret2libc gibi teknikleri ekleyin.")

    if percent >= 80 and kaspersky_ok and aslr_ok:
        print("\nâœ… Tebrikler! YazdÄ±ÄŸÄ±nÄ±z exploit oldukÃ§a saÄŸlam gÃ¶rÃ¼nÃ¼yor.")
        print("âœ… Hedef sistemde root yetkisi kazandÄ±nÄ±z!")
        print("ğŸ’€ Root@kgb:~# ")
        print('flag(rootforhacker090')
    else:
        print("\nâŒ Exploit yeterince saÄŸlam deÄŸil. BirkaÃ§ Ã¶nemli yapÄ± eksik.")

if __name__ == "__main__":
    main()
